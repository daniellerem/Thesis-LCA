---
title: "Opzet LCA MILC TREE"
author: "Daniëlle Remmerswaal"
date: "29-10-2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Structuur
1.	Intro
2.	Literatuur
  o	Total error framework 
  o	Verschil MTMM (2 fouten aan meetkant) ik: 1 fout aan meetkant, en 1 fout aan representatiekant
  o	
3.	Methoden
  o	MILC
  o	Tree structuur
  o	Simulatie van data
    	Populatiemodel 
    	Stap voor stap met code
4.	Resultaten



# Mentor feedback (12 november)
Send a version of your report to all students in your mentor group (Cc the mentor) no later than 5 PM on the Friday before the meeting (November 12th). Meeting is wednesday 17 november 
This whole meeting is about providing and receiving feedback on some aspects of the research report. The focus of the peer feedback is the reproducibility of the research design. Based on the research proposal and feedback from the BoS or your supervisor, you should be able to update your plan for your thesis. It is not needed to have a full report ready by now. The feedback you will give to your peer should be focused on the reproducibility of the research design. That is, will you be able to reproduce the results (which are probably not there yet) with the information provided in the analytic strategy.  It is unnecessary to give feedback on the introduction, although it helps to have n obvious research question and hypotheses.


# 1. Introduction

## 1.1. Problem
In many cases when official statistics are produced, only a subset from a population is selected. An example is a statistic on the energy consumption per economic sector. From a register containing all buildings in the Netherlands, only establishments are selected, and dwellings discarded. Information on energy consumption per building and on the type of building and, if applicable, the economic sector, is recorded in multiple data sources. To produce the statistic, the data sources, which are not error-free, are combined. In a composite dataset, a combination of registers and surveys on the same statistic, errors become noticeable. In this type of situation we can distinguish between selection errors (regarding the type of building) and classification errors (of the economic sectors). Possible causes of errors are typos during data entry, mismatching definitions (between the data collectors and the CBS researchers), or not having up-to-date answers (Groen, 2012). It is important to estimate and correct errors as to identify and minimize bias in statistics. 

## 1.3.	 Gap (from proposal)
For the estimation of categorical errors of one particular type, or in combination with 'method error' (MTMM situation), multiple methods are available to researchers. However, on approaches for situations where misclassifications can be identified as being caused by different error types (e.g. selection or classification error), not much research has been conducted. An unexplored potential solution for this situation, is the use of a latent class tree in combination with the MILC method. In this thesis this new latent class tree approach to the MILC method will be compared to the "normal" MILC method, in which an extra class is added for the wrongly selected units. The structure crucial to the two methods is visualised in section 2.2. with the described energy consumption per economic sector example.  
## 1.4.	 Research Question, hypotheses and expectations (from proposal)
This project aims to investigate whether the combination of the MILC-method with a latent class tree approach is an appropriate alternative to the MILC-method, to measure and correct for a combination of selection and classification errors. How well those approaches perform to estimate and correct the errors, will be investigated with a simulation study. Expectation is that the latent class tree structure gives more accurate estimates and more insight in the structure of data with those two types of errors, but is less straightforward to apply.

To perform the simulations and analyse the results, the freely-available opensource statistical software R will be used. In particular, the package poLCA will be used for the data simulation and the latent class analysis. (kopie zin)


# 2.	Literatuur

## 2.1. short (from proposal)
Several methods have been developed to estimate and correct for errors in categorical data. To estimate errors in data at one time-point, an important method is the latent variable model approach by Biemer (2011), with Latent Class Analysis (LCA) being specifically for errors in categorical variables. For categorical data measured multiple times, Hidden-Markov Models (HMM) can be used (Pavlopoulos & Vermunt, 2015; Pankowska, 2020). In survey research, systematic (caused by survey design) and random measurement error can be simultaneously studied with the multitrait-multimethod (MTMM) approach (Cernat and Oberski, 2018). The latent variable model is applicable on composite datasets under the assumption that the sources are locally independent. Those measurements are then used as the 'indicators' of a latent, unobserved, 'true' variable. The Multiple Imputing Latent Class (MILC) method uses a latent class model to can also be used to correct the true value for categorical errors, and sets the amount of latent classes equal to the number of categories in the variable of interest (Boeschoten, 2019). 

## LCA
Latent Class models are finite mixture models (fmm). (Latent class analysis is binomial fmm, latent profile analysis is gaussian fmm).

* Assumptions
Two key model assumptions (X is the latent class variable) 
1. (MIXTURE ASSUMPTION) Joint distribution mixture of 2 class-specific distributions: P(scorepattern)=P(x=1)P(scorepattern|X=1)+ P(x=2)P(scorepattern|X=2). Mixture of C classes. 
2. (LOCAL INDEPENDENCE ASSUMPTION) Within class X=x, responses are independent. P(scorepattern|X=1)=P(Q1=A1|X=1) * P(Q2=A2|X=1)* P(Q3=A3|X=1). K manifest variables.
Base calculations of posterior probabilities on mixture and local independence assumption. 

Classification via modal assignment: assign unit to latent class with highest P(X=x|Y=y)=P(Class|scorepattern)


* History
“A general framework for categorical data analysis with discrete latent variables was proposed by Hagenaars (1990) and extended by Vermunt (1997).”

##	Total error framework 

**Verschil MTMM (2 fouten aan meetkant) ik: 1 fout aan meetkant, en 1 fout aan representatiekant**

# 3. Methoden 

## 3.1. Analytical strategy Overview (from proposal)
.	Simulated datasets (N=10.000)
.	Variables: measurements of different datasources on same attribute 
.	Classes: the categories in variable of interest 
.	Variation: in the amount of selection and classification errors, and their relative proportions 
To be able to evaluate the performance of the beforementioned extensions of the MILC method to estimate and correct errors, simulated data will be used since herewith 'true values' are available. To perform the simulations and analyse the results, the freely-available opensource statistical software R will be used. In particular, the package poLCA will be used for the data simulation and the latent class analysis.

The simulated composite datasets will contain both selection and classification errors (of varying levels). In the simulated dataset the latent classes are the groups that are potentially misselected or misclassified, and each variable contains information on the categories from one data source. 
Next, the MILC method and the MILC-method with a latent class tree approach are both applied on the simulated datasets. The performance of the classifications of both methods is evaluated by comparing it to the original simulated datasets. The accuracy of the methods will be compared in terms of bias and confidence validity of the statistic under investigation, the proportion of the classes, and on how well they estimate the (relative) size of the two errors.
 

the latent class tree approach allows for the selection errors (building type) and classification errors (economic sectors) to be distinguished. Without this tree structure, the misclassified buildings will simply get allocated to an additional class. 

## MILC

## MILC with tree step

### Latent class trees (Mattis van den bergh)
The data is split and structured into classes by method of a sequential comparison of 1- and 2-class models. The top-down approach continues until the information criterion (e.g. BIC) no longer chooses 2-class models over 1-class models. The splits are performed based on the posterior class membership probabilities of each new class (child nodes) conditional on the class before the splitting (parent node). For the BIC (-2logL+log[N]P), N is the total sample size, not the sample size of the concerned node, and P the number of parameters. A larger BIC value indicates a more important split (a larger improvement of fit). 
To prevent label switching (order depends on random starting values), the larger class is given number 1 (in the picture the left branch) and the smaller class number 2 (right branch). 
classification performance in terms of R2Entropy, as a measure.
Advantages: clear insight in splitting of the classes and how models with different number of classes are related to each other, “the model selection problem reduces to deciding whether a particular split should be accepted” or not. ‘
The latent class tree approach is an alternative and insightful way to perform a latent class
Bergh, M. van den, Kollenburg, G.H. van, & Vermunt, J.K. Deciding on the starting number of classes of a Latent Class Tree.
Non-binary split at the root node of the tree is useful. This approach is then an intermediate between standard LC and LC tree analysis. 

## poLCA package

The poLCA package is an R software package for the estimation of latent class (regression) models for polytomous outcome variables. It is currently the only R package that allows the use of polytomous outcomes, and covariates. Other R packages for categorical outcome variables can only use binary outcomes. 

Potential shortcomings: poLCA recodes NA's to a seperate category (zero's) and does not make use of imputation methods.  

* explain: how does it work? (avoid overlap with literature) LC models are typically estimated by maximum likelihood, … log-likelihood function … .  EM algorithm, where EM stands for estimation and maximization. 


"The latent class regression model further enables the researcher to estimate the effects of covariates on predicting latent class membership."

"poLCA uses expectation-maximization and Newton-Raphson algorithms to find maximum likelihood estimates of the model parameters."

```{r}
#install.packages("poLCA") #install if not done yet
library(poLCA) #load the package into memory
```


* label problem 
"Because the latent classes are unordered categories, the numerical order of the estimated latent classes in the model output is arbitrary, and is determined solely by the start values of the EM algorithm. (Linzer and Lewis, 2011, poLCA, 4.6)
try to fix with label.switching package? more succesful approach is with poLCA.reorder(polcamodel$probs.start, c(1,3,2)) #example to switch order of second and third class. needed are the start probabilities of a model. So this is only a post-hoc fix, and not a general solution. 


Basics of poLCA simulation. 
```{r}
basic.sim <- poLCA.simdata(
  N=10000, #standard is 5000
  nclass = 3, #nr of latent classes, standard is 2
  ndv = 4, #nr of manifest variables, standard is 2
)
basic.sim$P

```
* proportions per class
If not specified, the proportions per class are specified randomly (like in the example above). P can be specified with the proportions for each of the latent classes. 
```{r}
basic.sim2 <- poLCA.simdata(N=10000,nclass=3,ndv=4,P=c(0.4, 0.3, 0.3))
basic.sim2$P
```
However, the specified proportions of the classes are 'overruled' when covariates are present.  
```{r}
#two covariates added
set.seed(123)
basic.sim3 <- poLCA.simdata(N=10000,nclass=3,ndv=4,P=c(0.4, 0.3, 0.3), niv = 2)
head(basic.sim3$dat) #four manifest variables and two covariates
basic.sim3$P #due to the covariates, the specified class proportions are overruled
basic.sim3$b #randomly drawn covariate structure with integers from -2 to 2
```

The class-conditional outcome probabilities of the manifest variables can be specified. 
```{r}
#specify outcome probabilities of the manifest variables 
set.seed(123)
#probabilities for three classes for four manifest variables
probs <- list(matrix(c(0.9,0.05,0.05,
                        0.05,0.9,0.05,
                        0.05,0.05,0.9 ), ncol=3,   byrow=TRUE), # Y1
               matrix(c(0.9,0.05,0.05,
                        0.05,0.9,0.05,
                        0.05,0.05,0.9 ), ncol=3, byrow=TRUE), # Y2
               matrix(c(0.90,0.05,0.05,
                        0.05,0.9,0.05,
                        0.05,0.05,0.9 ), ncol=3, byrow=TRUE), #Y3
               matrix(c(0.05,0.05,0.90,
                        0.05,0.9,0.05,
                        0.90,0.05,0.05 ), ncol=3, byrow=TRUE))#Y4
basic.sim4 <- poLCA.simdata(N=10000,nclass=2,ndv=2,P=c(0.4, 0.3, 0.3), probs= probs3)
basic.sim4$probs
```
As can be seen the probs argument overrules the specification of the number of classes and the number of manifest variables. 


## Data simulation  


The data with the two types of errors, the beforementioned selection and classification errors. 
```{r simsetup}
library(poLCA) 
options(scipen = 999) # remove scientific notation
set.seed(123) #set.seed for replicability
```



# 4. Application
## 4.1. Introduction to problem
"Determining the correct activity code of economic units is often rather difficult and prone to errors (e.g., Christensen 2008)."
Source: Delden, Scholtus and Burger (2015 & 2016)



